{% extends 'fund/blocks.html' %}

{% block script %}
<script type="text/javascript">

function toggle(a, b) { //shows a, hides b
  var e=document.getElementById(a);
  var f=document.getElementById(b);
  if(!e)return true;
  if(e.style.display=="none"){
    e.style.display="block"
	f.style.borderColor="#333"
  } else {
    e.style.display="none"
	f.style.borderColor="#FFF"
  }
  return true;
}

function datepicker() {
	$.datepicker.setDefaults({
		dateFormat: 'yy-mm-dd',
		minDate: 0,
		hideIfNoPrevNext: true,
	});
	$( ".datePicker" ).datepicker();
}

function loadView(get_url, div_id) {
	$.ajax({
		url:get_url,
		type:"GET",
		success:function(data, textStatus, jqXHR){
			document.getElementById(div_id).innerHTML=jqXHR.responseText;
			datepicker();
		},
		failure:function(jqXHR, textStatus, errorThrown){
			document.getElementById(div_id).innerHTML="Error! "+textStatus+' '+errorThrown;
		},
	});
}

function cancelHide(div_id, replace) {
	replace = replace || '';
	document.getElementById(div_id).innerHTML=replace;
}

function Submit(sub_url, form_id, div_id, date){
$.ajax({
	url:sub_url,
	type:"POST",
	data:$(form_id).serialize(),
	success:function(data, textStatus, jqXHR){
		if (jqXHR.responseText=="success") {
			location.reload();
		} else {
			document.getElementById(div_id).innerHTML=jqXHR.responseText;
		}
		if (date) { datepicker(); }
	},
	error:function(jqXHR, textStatus, errorThrown){
		document.getElementById(div_id).innerHTML="Error! "+textStatus+' '+errorThrown;
		if (date) { datepicker(); }
	},
});
}

function SubmitMult() {
$.ajax({
	url:'/fund/addmult',
	type:"POST",
	data:$('#addmult').serialize(),
	success:function(data, textStatus, jqXHR){
		if (jqXHR.responseText=="success") {
			loadView('/fund/stepmult', 'adddonor');
		} else {
			document.getElementById('adddonor').innerHTML=jqXHR.responseText;
		}
	},
	error:function(jqXHR, textStatus, errorThrown){
		document.getElementById('adddonor').innerHTML="Error! "+textStatus+' '+errorThrown;
	},
});
}

function cloneMore(selector, type) { //adds a row to the multiple contacts form
	var newElement = $(selector).clone(true);
	var total = $('#id_' + type + '-TOTAL_FORMS').val();
	newElement.find(':input').each(function() {
			var name = $(this).attr('name').replace('-' + (total-1) + '-','-' + total + '-');
			var id = 'id_' + name;
			$(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
	});
	newElement.find('label').each(function() {
			var newFor = $(this).attr('for').replace('-' + (total-1) + '-','-' + total + '-');
			$(this).attr('for', newFor);
	});
	total++;
	$('#id_' + type + '-TOTAL_FORMS').val(total);
	$(selector).after(newElement); // only copies last row, not incl error row. but error row will load when form reloads
}

function suggestFill(source, target) { //fills input with the selected step
	var text = source.innerHTML;
	if (target) {
		document.getElementById(target).value=text;
	} else {
		document.getElementById('id_description').value=text;
	}
}

var div;
function showSuggestions(inp) { //shows suggested steps
	if (div) { div.style.display="none"; } //hides prior set
	var patt = new RegExp('\\d');
	var num = patt.exec(inp);
	div = document.getElementById('suggest_'+num);
	div.style.display="block";
}

</script>
{% endblock %}

{% block progress %}
<div id="progress_container">
<div id="progress_bar" style="width:{{progress.bar}}%">
</div></div>
<div id="progress_desc">You've asked {{progress.asked}} p{{progress.asked|pluralize:"erson,eople"}} so far</div>

{% endblock %}

{% block content %}
{% if notif %}
<div id="notifications">{{notif|safe}}</div>
{% endif %}

<b>YOUR PROGRESS</b>
<div class="indent">
<table style="width:100%;">
<tr>
	<td style="width:50%;">
	{{progress.contacts}} contacts<br>
	{{progress.talked}} talked to<br>
	{{progress.asked}} asked<br></td>
	<td>
	${{progress.estimated}} estimated fundraising<br>
	${{progress.pledged}} pledged<br>
	${{progress.gifted}} gifted<br>
	</td>
</tr></table>
</div>

<b>YOUR CONTACTS</b>
{% if donors %} <!--only show if mass add won't be showing -->
	<div class="edit_done">[<a onclick="loadView('/fund/add', 'adddonor')">add contact</a>]</div>
  <div class="donors" id="adddonor"></div><!--forms for adding contacts go here when requested-->
{% endif %}

{% for dict in donor_list %}
	<div class="donor indent" id="donor-{{dict.donor.pk}}">
		<a class="{%if dict.donor.pledged != None%}pledged{%endif%}" onclick="toggle('details-{{dict.donor.pk}}', 'donor-{{dict.donor.pk}}')"><b>{{dict.donor.firstname}} {{donor.lastname}}</b></a>
		<br>
		{% if dict.next_step %}
			<div id="{{dict.donor.pk}}-nextstep">{%if dict.overdue%}<div title="This step's goal date has passed! Edit or complete it" style="display:inline;"><div class="overdue_step">! </div>{{dict.next_step}}</div>{% else %}{{dict.next_step}}{%endif%}
			<div class="edit_done"> [<a class="edit_done" onclick="loadView('/fund/{{dict.donor.pk}}/{{donor.get_next_step.pk}}', '{{dict.donor.pk}}-nextstep')">edit</a>|<a class="edit_done" onclick="loadView('/fund/{{dict.donor.pk}}/{{dict.next_step.pk}}/done', '{{dict.donor.pk}}-nextstep')">complete</a>]</div>
			</div>
		{% else %}
			<div id="{{dict.donor.pk}}-addstep">
			{% if dict.donor.pledged == None %}
				No next step. <a onclick="loadView('/fund/{{dict.donor.pk}}/step', '{{dict.donor.pk}}-addstep')">Add one.</a>
			{% else %}
				<img src="/static/images/check.png"/>Asked.
			{% endif %}
			</div>
		{% endif %}

		<div class="donor_details indent" id="details-{{dict.donor.pk}}" style="display:none;">
	
		<table>
		
			{% if dict.donor.gifted %}
				<tr><td>Donated:</td><td>${{dict.donor.gifted}}</td></tr>
			{% else %}
				{%if dict.donor.pledged%}
					{% if dict.donor.pledged > 0 %}
						<tr><td>Pledged:</td><td>${{dict.donor.pledged}}</td></tr>
					{% else %}
						<tr><td colspan="2">Declined to donate.</td></tr>
					{% endif %}
				{% else %}
					{% if dict.donor.asked %}
						<tr><td colspan="2">Asked; awaiting reply.</td></tr>
					{% endif %}
					<tr><td>Amount to ask:</td><td>${{dict.donor.amount}}</td></tr>
					<tr><td>Likelihood:</td><td>{{dict.donor.likelihood}}%</td></tr>
				{% endif %}
			{% endif %}
			
			<tr>
				<td>{% if dict.donor.email or dict.donor.phone %}Contact info:</td>
				<td>{{dict.donor.email|default:""}} {{dict.donor.phone|default:""}}{%endif%}</td>
			</tr>
			<tr><td colspan="2"> </td></tr>
			
			{% if dict.complete_steps %}
				<tr>
					<td>Completed steps:{% if dict.donor.pledged != None and not dict.next_step %}<br>
					[<a onclick="loadView('/fund/{{dict.donor.pk}}/step', '{{dict.donor.pk}}-addstep')">add step</a>]{% endif %}
					</td>
					<td>
						{% for step in dict.complete_steps %}
							{{step.date|date:"n/d/y"}}: {{step.description}}<br>
						{% endfor %}
					</td>
				</tr>
			{% endif %}
		
		</table>
		<br>
		
		<div class="donor_delete" id="delete-{{dict.donor.pk}}">
			[<a onclick="loadView('/fund/{{dict.donor.pk}}/edit', 'donor-{{dict.donor.pk}}')">edit contact</a>] [<a onclick="loadView('/fund/{{dict.donor.pk}}/delete', 'delete-{{dict.donor.pk}}')">remove contact</a>]
		</div>
		
	</div> <!-- ends donor_details -->
	</div> <!-- ends donor -->

{% empty %} <!--no contacts yet -->
<div class="donors" id="adddonor">
  <p>You don't have any contacts yet!  Get started by adding some.  You'll be able to add, change or remove contacts at any time.</p>
	{% include 'fund/add_mult.html' %}
</div>

{% endfor %} <!--ends contacts check-->

{% endblock %}