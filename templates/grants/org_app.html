{% extends 'grants/base.html' %}
{% block script %}
<script type="text/javascript">
var autosave_timer;
var upload_url_timer;

var status_texts = { //for ajax error messages
  400: '400 Bad request',
  401: '401 Unauthorized',
  403: '403 Forbidden',
  404: '404 Not found',
  408: '408 Request timeout',
  500: '500 Internal server error',
  503: '503 Service unavailable',
  504: '504 Gateway timeout',
}

function autoSave(){
	$.ajax({
		url:"/apply/"+{{cycle.pk}}+"/autosave/",
		type:"POST",
		data:$('form').serialize(),
		success:function(){
			var monthNames = [ "January", "February", "March", "April", "May", "June",
			"July", "August", "September", "October", "November", "December" ];
			var d = new Date();
			var h = d.getHours();
			var m = d.getMinutes();
			/*var s = d.getSeconds();*/
			var dd = "a.m.";
			if (h >= 12) {
				h = h-12;
				dd = "p.m.";
			}
			if (h == 0) {
				h = 12;
			}
			m = m<10?"0"+m:m;
			/* s = s<10?"0"+s:s; */
			var da = monthNames[d.getMonth()]+' '+d.getDate()+', '+h+':'+m+dd;
			document.getElementById('autosaved').innerHTML=da;
		},
		error:function(jqXHR, textStatus, errorThrown){
			var errortext = ''
      if (status_texts[jqXHR.status]) {
        errortext = status_texts[jqXHR.status]
      } else if (textStatus=='timeout') {
        errortext = 'Request timeout'
      } else {
        errortext = 'Unknown error'
      }
      document.getElementById('autosaved').innerHTML='Error: ' + errortext + '<br>If you are seeing errors repeatedly please <a href="/org/support#contact">contact us</a>';
		},
	});
}

function charLimitDisplay(area, limit){
	var counter = document.getElementById(area.name + '_counter');
	var diff = limit - area.value.length;
  if (diff >= 0) {
    counter.innerHTML = diff + ' characters remaining';
    counter.className = 'char_counter_ok';
  } else {
    counter.innerHTML = -diff + ' characters over the limit';
    counter.className = 'char_counter_over';
  } 
}

function getUploadURL() {
	$.ajax({
		url: '/get-upload-url/{{cycle.pk}}',
		success: function(data) {
			document.forms[0].action = data;
			window.setTimeout("getUploadURL()", 540000);
		},
	});
}

$(document).ready(function() {
	autosave_timer = window.setInterval("autoSave()", 30000);
	upload_url_timer = window.setTimeout("getUploadURL()", 540000);
	$('.char_counter').each(function(index) {
		var id = "id_" + this.id.replace("_counter","");
    var area = document.getElementById(id);
		var limit = parseInt(this.innerHTML);
		charLimitDisplay(area, limit);
	});
});
</script>
{%endblock%}

{% block content %}
{% load tz %}
<div class="formwrapper">
<form action="{{upload_url}}" method="POST" enctype="multipart/form-data">

  <div id="test" style="display:none;">
    TEST ONLY: {{form.errors}}{{form.organization}}{{form.grant_cycle}}
	</div>
	
  <div align="center">
    <h1>{{cycle}} Application</h1>
    <span id="last_saved">Last saved: <span id="autosaved">{%if saved %}{{saved|date:"F j, g:ia"}}{%else%}never{% endif %}</span></span>
	</div>
  
  {% autoescape off %}
  <table id="application_form"><!-- Form starts -->
    <tr>
      <td><h4>Contact information</h4></td> <!-- Contact information -->
    </tr> 
    <tr>
      <td>{{form.address.errors}}</td>
      <td>{{form.city.errors}}</td>
    </tr><tr>
      <td>{{form.address.label}}{{form.address}}</td>
      <td>{{form.city.label}}{{form.city}} </td>
    </tr>   
    <tr>
      <td>{{form.state.errors}}</td>
      <td>{{form.zip.errors}}</td>
    </tr><tr>
      <td>{{form.state.label}}{{form.state}}</td>
      <td>{{form.zip.label}}{{form.zip}}</td>
    </tr>    
    <tr>
      <td>{{form.telephone_number.errors}}</td>
      <td>{{form.fax_number.errors}}</td>
    </tr><tr>
      <td>{{form.telephone_number.label}}{{form.telephone_number}}</td>
      <td>{{form.fax_number.label}}{{form.fax_number}}</td>
    </tr>    
    <tr>
      <td>{{form.email_address.errors}}</td>
      <td>{{form.website.errors}}</td>
    </tr><tr>
      <td>{{form.email_address.label}}{{form.email_address}}</td>
      <td>{{form.website.label}}{{form.website}}</td>
    </tr><tr>
      <td><h4>Organization information</h4></td> <!-- Organization information -->
    </tr><tr>
      <td colspan="2">{{form.status.errors}}{{form.status.label}}{{form.status}}</td>
    </tr> 
    <tr>
      <td>{{form.ein.errors}}</td>
      <td>{{form.founded.errors}}</td>
    </tr><tr>
      <td>{{form.ein.label}}{{form.ein}}</td>
      <td>{{form.founded.label}}{{form.founded}}</td>
    </tr>   
    <tr>
      <td colspan="2"><div class="vertical_cushion">{{form.mission.label}}{{form.mission.errors}}</div>
      {{form.mission}}</td>
    </tr><tr>
      <td colspan="2">{{form.previous_grants.errors}}</td>
    </tr><tr>
      <td colspan="2">{{form.previous_grants.label}}{{form.previous_grants}}</td>
    </tr><tr>
      <td><h4>Fiscal sponsor information (if applicable)</h4></td><!-- Fiscal sponsor info -->
    </tr><tr>
      <td>{{form.fiscal_org.errors}}</td>
      <td>{{form.fiscal_person.errors}}</td>
    </tr><tr>
      <td>{{form.fiscal_org.label}}{{form.fiscal_org}}</td>
      <td>{{form.fiscal_person.label}}{{form.fiscal_person}}</td>
    </tr><tr>
      <td>{{form.fiscal_telephone.errors}}</td><td>{{form.fiscal_email.errors}}</td>
    </tr><tr>
      <td>{{form.fiscal_telephone.label}}{{form.fiscal_telephone}}</td>
      <td>{{form.fiscal_email.label}}{{form.fiscal_email}}</td>
    </tr><tr>
      <td colspan="2">{{form.fiscal_address.errors}}</td>
    </tr><tr>
      <td colspan="2">{{form.fiscal_address.label}}{{form.fiscal_address}}</td>
    </tr><tr>
			<td colspan="2"><div class="vertical_cushion">{{form.fiscal_letter.help_text}}</div></td>
		</tr><tr>
			<td>{{form.fiscal_letter.errors}}</td>
		</tr><tr>	
			<td>{{form.fiscal_letter}}</td>
			<td>{% if files.fiscal_letter %}<a href="{{file_urls.fiscal}}grants/draft-file/{{files.pk}}/fiscal" target="_blank">{{files.fiscal_letter}}</a>{% endif %}</td>
		</tr><tr>
      <td><h4>Budget information</h4></td><!-- Budget information -->
    </tr><tr>
			<td>{{form.start_year.label}}{{form.start_year}}</td>
			<td>{{form.start_year.errors}}</td>
    </tr><tr>
      <td>{{form.budget_last.errors}}</td>
      <td>{{form.budget_current.errors}}</td>
    </tr><tr>
      <td>{{form.budget_last.label}} ${{form.budget_last}} </td>
      <td>{{form.budget_current.label}} ${{form.budget_current}}</td>
    </tr><tr>
      <td><h4>Grant information</h4></td><!-- Grant information -->
    </tr><tr>
      <td colspan="2"><div class="vertical_cushion">{{form.grant_request.label}}{{form.grant_request.errors}}</div>
      {{form.grant_request}}</td>
    </tr><tr>
      <td colspan="2">{{form.contact_person.help_text}}</td>
    </tr><tr>
			<td>{{form.contact_person.errors}}</td>
			<td>{{form.contact_person_title.errors}}</td>
		</tr>
		<tr>
      <td>{{form.contact_person.label}}{{form.contact_person}}</td>
      <td>{{form.contact_person_title.label}}{{form.contact_person_title}}</td>
    </tr><tr>
      <td colspan="2">{{form.grant_period.label}}{{form.grant_period}}{{form.grant_period.errors}}</td>
    </tr><tr>
      <td>{{form.amount_requested.errors}}</td><td>{{form.support_type.errors}}</td>
    </tr><tr>
      <td>{{form.amount_requested.label}}{{form.amount_requested}}</td>
      <td>{{form.support_type.label}}{{form.support_type}}</td>
    </tr><tr>
      <td>{{form.project_title.errors}}</td>
      <td>{{form.project_budget.errors}}</td>
    </tr><tr>
      <td>{{form.project_title.label}}{{form.project_title}}</td>
      <td>{{form.project_budget.label}} ${{form.project_budget}}</td>
    </tr>
  </table>

  <h4>Narrative</h4><!-- Narrative -->

	Be as specific as possible when responding to each item. Your responses will reflect on the soundness of your organizational structure, your social change strategy and your organizing plan.	Please keep in mind that the strength of your written application will significantly influence the overall score you receive in the decision-making process.
	
	<div class="narrative_q">1. {{form.narrative1.label}}<br><br>
	{{form.narrative1.errors}}{{form.narrative1}}
	<span class="char_counter" id="narrative1_counter">{{limits.1}}</span></div>

	<div class="narrative_q">2. {{form.narrative2.label}}
	{{form.narrative2.errors}}{{form.narrative2}}
	<span class="char_counter" id="narrative2_counter">{{limits.2}}</span></div>

	<div class="narrative_q">3. {{form.narrative3.label}}
	{{form.narrative3.errors}}{{form.narrative3}}
	<span class="char_counter" id="narrative3_counter">{{limits.3}}</span></div>

	<div class="narrative_q">4. {{form.narrative4.label}}
	{{form.narrative4.errors}}{{form.narrative4}}
	<span class="char_counter" id="narrative4_counter">{{limits.4}}</span></div>

	<div class="narrative_q">5. {{form.narrative5.label}}
	{{form.narrative5.errors}}{{form.narrative5}}
	<span class="char_counter" id="narrative5_counter">{{limits.5}}</span>
	<table class="narrative_references"><tr>
	<td colspan="4">{{form.collab_ref1_name.help_text}}</td>
	</tr><tr class="main_row">
	<td>{{form.collab_ref1_name.label}}</td>
	<td>{{form.collab_ref1_org.label}}</td>
	<td>{{form.collab_ref1_phone.label}}</td>
	<td>{{form.collab_ref1_email.label}}</td>
	</tr><tr>
	<td>{{form.collab_ref1_name.errors}}</td>
	<td>{{form.collab_ref1_org.errors}}</td>
	<td>{{form.collab_ref1_phone.errors}}</td>
	<td>{{form.collab_ref1_email.errors}}</td>
	</tr><tr>
	<td>{{form.collab_ref1_name}}</td>
	<td>{{form.collab_ref1_org}}</td>
	<td>{{form.collab_ref1_phone}}</td>
	<td>{{form.collab_ref1_email}}</td>
	</tr><tr>
	<td>{{form.collab_ref2_name.errors}}</td>
	<td>{{form.collab_ref2_org.errors}}</td>
	<td>{{form.collab_ref2_phone.errors}}</td>
	<td>{{form.collab_ref2_email.errors}}</td>
	</tr><tr>
	<td>{{form.collab_ref2_name}}</td>
	<td>{{form.collab_ref2_org}}</td>
	<td>{{form.collab_ref2_phone}}</td>
	<td>{{form.collab_ref2_email}}</td>
	</tr></table>
	</div>
	
	<div class="narrative_q">6. {{form.narrative6.label}}
	{{form.narrative6.errors}}{{form.narrative6}}
	<span class="char_counter" id="narrative6_counter">{{limits.6}}</span>
	<table class="narrative_references"><tr>
	<td colspan="4">{{form.racial_justice_ref1_name.help_text}}</td>
	</tr><tr class="main_row">
	<td>{{form.racial_justice_ref1_name.label}}</td>
	<td>{{form.racial_justice_ref1_org.label}}</td>
	<td>{{form.racial_justice_ref1_phone.label}}</td>
	<td>{{form.racial_justice_ref1_email.label}}</td>
	</tr><tr>
	<td>{{form.racial_justice_ref1_name.errors}}</td>
	<td>{{form.racial_justice_ref1_org.errors}}</td>
	<td>{{form.racial_justice_ref1_phone.errors}}</td>
	<td>{{form.racial_justice_ref1_email.errors}}</td>
	</tr><tr>
	<td>{{form.racial_justice_ref1_name}}</td>
	<td>{{form.racial_justice_ref1_org}}</td>
	<td>{{form.racial_justice_ref1_phone}}</td>
	<td>{{form.racial_justice_ref1_email}}</td>
	</tr><tr>
	<td>{{form.racial_justice_ref2_name.errors}}</td>
	<td>{{form.racial_justice_ref2_org.errors}}</td>
	<td>{{form.racial_justice_ref2_phone.errors}}</td>
	<td>{{form.racial_justice_ref2_email.errors}}</td>
	</tr><tr>
	<td>{{form.racial_justice_ref2_name}}</td>
	<td>{{form.racial_justice_ref2_org}}</td>
	<td>{{form.racial_justice_ref2_phone}}</td>
	<td>{{form.racial_justice_ref2_email}}</td>
	</tr></table>
	</div>
  
	<h4>File uploads</h4><!-- Files -->
	<ul><li>Files are not autosaved</li>
	<li>If an incomplete form is submitted, those files will be saved along with the draft</li>
	<li>Uploaded files overwrite any previously saved files</li></ul>
  <p>Please download the provided template, fill it out, and upload it once it is complete.  For the budget, you may use your own format if preferred.</p>
  <table style="width:98%;">
    <tr>
			<td></td>
			<td>{{form.budget.errors}}</td>
			<td></td>
		</tr>
		<tr>
			<td>Budget: <a href="/static/grant_app/budget.doc" target="_blank">optional template</a></td>
			<td>{{form.budget}}</td>
			<td>{% if files.budget %}<a href="{{file_urls.budget}}grants/draft-file/{{files.pk}}/budget" target="_blank">{{files.budget}}</a>{% endif %}</td>
		</tr><tr>
			<td></td>
			<td>{{form.demographics.errors}}</td>
			<td></td>
		</tr>
		<tr>
			<td>Organizational Diversity Chart: <a href="/static/grant_app/diversity_chart.doc" target="_blank">template</a></td>
			<td>{{form.demographics}}</td>
			<td>{% if files.demographics %}<a href="{{file_urls.demographics}}grants/draft-file/{{files.pk}}/demographics" target="_blank">{{files.demographics}}</a>{% endif %}</td>
		</tr><tr>
			<td></td>
			<td>{{form.funding_sources.errors}}</td>
			<td></td>
		</tr>
		<tr>
			<td>Funding sources:<a href="/static/grant_app/funding_sources.doc" target="_blank">template</a></td>
			<td>{{form.funding_sources}}</td>
			<td>{% if files.funding_sources %}<a href="{{file_urls.funding}}grants/draft-file/{{files.pk}}/funding" target="_blank">{{files.funding_sources}}</a>{% endif %}</td>
		</tr>
	</table>
  {% endautoescape %}
  <div align="center"><input id="grant_submit" type="submit" value="Submit Application"/></div>
</form>
{% endblock %}